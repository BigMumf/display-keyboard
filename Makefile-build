
# Fefore running:
# . $HOME/esp/esp-idf/export.sh

# pip install esptool
PORT=/dev/cu.usbserial-GT4YU06W
BAUD=921600
IDF=idf.py
ESPTOOL=esptool.py
FS_BLOCK_SIZE=4096
FS_PAGE_SIZE=256
FS_IMAGE_SIZE=0x100000
PARTITION_OFFSET=0x110000

GIT_SUBMODULES=components/i2clib \
							 components/inih \
							 components/tinyusb \
							 components/lv_port_esp32

.PHONY: format clean target build flash config monitor submodules-update

format:
	clang-format -i main/*.cc main/*.c main/*.h

clean:
	rm -rf build sdkconfig.old

config:
	${IDF} menuconfig

target:
	${IDF} set-target esp32s2

build:
	${IDF} build

build/bootloader/bootloader.bin:
	${IDF} build

flash:
	${IDF} --port ${PORT} --baud ${BAUD} flash monitor

# Manual flash should be the equivalent of the flash target above.
.PHONY:
manual-flash: build/bootloader/bootloader.bin
	esptool.py --chip esp32s2 --port ${PORT} --baud ${BAUD} \
		--before=default_reset --after=no_reset write_flash \
		--flash_mode dio --flash_size detect --flash_freq 80m \
		0x1000 build/bootloader/bootloader.bin \
		0x8000 build/partition_table/partition-table.bin \
		0x10000 build/keyboard.bin \
		0x210000 build/storage.bin; \
		echo "Press the RST button."

monitor:
	${IDF} --port ${PORT} monitor

.PHONY:
flash-erase:
	${ESPTOOL} --chip esp32s2 --port ${PORT} --baud ${BAUD} erase_flash

# Instructions from https://feathers2.io/install_uf2.html
.PHONY:
flash-feathers2-stock-bootloader:
	esptool.py --chip esp32s2 --port ${PORT} --baud ${BAUD} \
		--before=default_reset --after=no_reset write_flash \
		--flash_mode dio --flash_size detect --flash_freq 80m \
		0x1000 FeatherS2Files/bootloader.bin \
		0x8000 FeatherS2Files/partition-table.bin \
		0xe000 FeatherS2Files/ota_data_initial.bin \
		0x410000 FeatherS2Files/tinyuf2.bin; \
		echo "Press the RST button."

submodules-update:
	git submodule update --init ${GIT_SUBMODULES}
	git -C components/lv_port_esp32 submodule update --init components/lvgl/lvgl
